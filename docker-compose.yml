services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: focusshield-frontend
    restart: unless-stopped
    ports:
    - 127.0.0.1:3012:80
    depends_on:
    - api
    healthcheck:
      test:
      - CMD
      - wget
      - --quiet
      - --tries=1
      - --spider
      - http://localhost/
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    cap_drop:
    - ALL
    security_opt:
    - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 256M
          pids: 200
    cap_add:
    - CHOWN
    - DAC_OVERRIDE
    - FOWNER
    - SETGID
    - SETUID
    - NET_BIND_SERVICE
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: focusshield-api
    restart: unless-stopped
    ports:
    - 127.0.0.1:3011:3000
    environment:
    - DATABASE_URL=postgresql://focusshield:${DB_PASSWORD:?DB_PASSWORD required}@db:5432/focusshield
    - JWT_SECRET=${JWT_SECRET:?JWT_SECRET required}
    - JWT_EXPIRES_IN=7d
    - NODE_ENV=production
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - wget
      - --quiet
      - --tries=1
      - --spider
      - http://localhost:3000/health
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    cap_drop:
    - ALL
    security_opt:
    - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M
          pids: 200
    cap_add:
    - CHOWN
    - DAC_OVERRIDE
    - FOWNER
    - SETGID
    - SETUID
  db:
    image: postgres:15-alpine
    container_name: focusshield-db
    restart: unless-stopped
    environment:
    - POSTGRES_USER=focusshield
    - POSTGRES_PASSWORD=${DB_PASSWORD:?DB_PASSWORD required}
    - POSTGRES_DB=focusshield
    volumes:
    - focusshield_data:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U focusshield
      interval: 10s
      timeout: 5s
      retries: 5
    cap_drop:
    - ALL
    security_opt:
    - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M
          pids: 200
    cap_add:
    - CHOWN
    - DAC_OVERRIDE
    - FOWNER
    - SETGID
    - SETUID
volumes:
  focusshield_data: null
